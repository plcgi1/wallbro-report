angular.module("plcgi.eventbus",[]).factory("EventBus",["$rootScope",function($rootScope){var eventBus={};return eventBus.model={},eventBus.prepForBroadcast=function(eventName,key,model){this.model[key]=model,this.broadcastItem(eventName,key),$rootScope.$$phase||$rootScope.$apply()},eventBus.broadcastItem=function(eventName,key){$rootScope.$broadcast(eventName,eventBus.model[key])},eventBus}]),function(){window.app=angular.module("report",["ngRoute","report.controllers","ui.bootstrap","plcgi.eventbus","angularFileUpload"]),window.app.controllers=angular.module("report.controllers",["ui.bootstrap","plcgi.eventbus","angularFileUpload"]),window.app.config(function($routeProvider,$httpProvider){$routeProvider.when("/",{templateUrl:"views/report.html",controller:"ReportCtrl"}).when("/:report_id",{templateUrl:"views/report.html",controller:"ReportCtrl"}).otherwise({redirectTo:"/"});var interceptor=["$rootScope","$q","appLoading",function(scope,$q,appLoading){function success(response){return appLoading.ready(),response}function error(response){var arr=(response.status,[]);for(var item in response.data)arr.push('<div class="alert alert-error">'+response.data[item].message+"</div>");return appLoading.ready(),$q.reject(response)}return function(promise){return appLoading.loading(),promise.then(success,error)}}];$httpProvider.responseInterceptors.push(interceptor)}).factory("appLoading",function($rootScope){var timer;return{loading:function(){clearTimeout(timer),$rootScope.status="loading",$rootScope.$$phase||$rootScope.$apply()},ready:function(delay){function ready(){$rootScope.status="ready",$rootScope.$$phase||$rootScope.$apply()}clearTimeout(timer),delay=null===delay?500:!1,delay?timer=setTimeout(ready,delay):ready()}}})}(),function(){"use strict";var app=window.app;app.controllers.controller("ReportCtrl",function($scope,$http,$modal,$location,$routeParams,EventBus){function calc_total(data){var total=0;return angular.forEach(data,function(item){total=parseFloat(total+item.rate*item.value)}),total}function remove_row(row){$http.get("rest.php?action=remove_row&id="+row.id).success(function(){if($scope.data&&$scope.data.length>0){for(var new_data=[],i=0;i<$scope.data.length;i++)$scope.data[i].id!=row.id&&new_data.push($scope.data[i]);$scope.data=new_data}}).error(function(){alert("server error"),console.log(arguments)})}function set_company_title(){angular.forEach($scope.companies,function(item){return $scope.company_id===item.id?void($scope.company_title=item.name):void 0}),angular.isNumber($scope.report_id)&&$http.post("rest.php?action=change_company",{report_id:$scope.report_id,company_id:$scope.company_id}).success(function(){}).error(function(){alert("server error"),console.log(arguments)})}function show_edit(row){row?($scope.edit=1,$scope.row=row):($scope.row={report_id:$scope.report_id,company_id:$scope.company_id},delete $scope.edit),modalInstance=$modal.open({templateUrl:"views/lib/row.html",controller:RowDlgCtrl,scope:$scope,resolve:{row:function(){return $scope.row},campaigns:function(){return $scope.campaigns},categories:function(){return $scope.categories}}})}function set_category_title(){angular.forEach($scope.categories,function(item){return $scope.row.category_id===item.id?void($scope.row.category_title=item.name):void 0})}function save(){var edit=!1,index=0;set_category_title($scope.category_id);for(var i=0;i<$scope.data.length;i++)if($scope.data[i].id===$scope.row.id){$scope.data[i]=$scope.row,index=i,edit=!0;break}$scope.row.company_id=$scope.company_id,$scope.row.report_id=$scope.report_id,$http.post("rest.php?action=save",$scope.row).success(function(data){$scope.row.id=data.id,$scope.row.report_id=data.report_id,edit||($scope.data.push($scope.row),$location.url(""+data.report_id)),$scope.row={},modalInstance.close()}).error(function(){alert("server error"),console.log(arguments)})}($routeParams.report_id||"undefined"!=typeof $routeParams.report_id)&&($scope.report_id=$routeParams.report_id),$scope.data=[],$scope.row={},$scope.companies=[],$http.get("rest.php?action=categories").success(function(data){$scope.categories=data}),$http.get("rest.php?action=companies").success(function(data){$scope.companies=data}),$scope.report_id&&$http.get("rest.php?action=get_report&id="+$scope.report_id).success(function(data){$scope.data=data.rows,$scope.report_id=data.report_id,$scope.company_id=data.company_id,set_company_title(),set_category_title(),EventBus.prepForBroadcast("reportDataReady","report_id",$scope.report_id)}),$scope.calculate_me=function(a,b){if(a&&b){var res=parseFloat(a*b);return res}return 0};var modalInstance;$scope.show_edit=show_edit,$scope.set_company_title=set_company_title,$scope.remove_row=remove_row,$scope.calc_total=calc_total;var RowDlgCtrl=function($scope,$modalInstance,row,campaigns,categories){$scope.row=row,$scope.campaigns=campaigns,$scope.categories=categories,$scope.save=save}})}(),function(){"use strict";var app=window.app;app.controllers.controller("UploadCtrl",function($scope,$http,FileUploader){function remove(item){$http.get("rest.php?action=remove_report_file&id="+item.id).success(function(){item.remove()})}$scope.$on("reportDataReady",function(evt,report_id){$scope.report_id=report_id});var uploader=$scope.uploader=new FileUploader({url:"rest.php?action=upload&report_id="+$scope.report_id});($scope.report_id||"undefined"!=typeof $scope.report_id)&&$http.get("rest.php?action=get_report_files&report_id="+$scope.report_id).success(function(data){for(var i=0;i<data.files.length;i++){var item=data.files[i],name=item.name.split("/");name=name[name.length-1];var dummy=new FileUploader.FileItem(uploader,{lastModifiedDate:new Date,size:item.size,type:item.type,name:name});dummy.id=item.id,dummy.progress=100,dummy.isUploaded=!0,dummy.isSuccess=!0,uploader.queue.push(dummy)}}),$scope.remove=remove,uploader.filters.push({name:"imageFilter",fn:function(item){var type="|"+item.type.slice(item.type.lastIndexOf("/")+1)+"|";return-1!=="|jpg|png|jpeg|bmp|gif|".indexOf(type)}}),uploader.onWhenAddingFileFailed=function(item,filter,options){console.info("onWhenAddingFileFailed",item,filter,options)},uploader.onAfterAddingFile=function(fileItem){console.info("onAfterAddingFile",fileItem)},uploader.onAfterAddingAll=function(addedFileItems){console.info("onAfterAddingAll",addedFileItems)},uploader.onBeforeUploadItem=function(item){console.info("onBeforeUploadItem",item)},uploader.onProgressItem=function(fileItem,progress){console.info("onProgressItem",fileItem,progress)},uploader.onProgressAll=function(progress){console.info("onProgressAll",progress)},uploader.onSuccessItem=function(fileItem,response,status,headers){console.info("onSuccessItem",fileItem,response,status,headers)},uploader.onErrorItem=function(fileItem,response,status,headers){console.info("onErrorItem",fileItem,response,status,headers)},uploader.onCancelItem=function(fileItem,response,status,headers){console.info("onCancelItem",fileItem,response,status,headers)},uploader.onCompleteItem=function(fileItem,response,status,headers){console.info("onCompleteItem",fileItem,response,status,headers)},uploader.onCompleteAll=function(){console.info("onCompleteAll")},console.info("uploader",uploader)})}();